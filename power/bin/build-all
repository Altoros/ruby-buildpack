#!/usr/bin/env ruby
require 'yaml'
require 'fileutils'
require 'open-uri'

def usage
  puts "usage:"
  puts "  build-all <manifest-file>"
  puts
  puts "  build dependencies needed by Ruby buildpack"
  exit(1)
end

def download(options)
  url, file  = options[:from], options[:to]
  File.open(file, 'wb') do |fo|
    fo.write open(url).read
  end
end

manifest_file = ARGV.first
packages = YAML.load_file(manifest_file)

root_folder = File.expand_path(File.join(File.dirname(__FILE__), '..'))

build_folder = File.join(root_folder, 'build')
scripts_folder = File.join(root_folder, 'scripts')
target_folder = File.join(root_folder, 'target')

packages.each do |package|
  Dir.chdir(build_folder) do |dir|
    package_name = "#{package['name']}-#{package['version']}"
    archive_file_name = "#{package_name}.tar.gz"
    puts "Downloading #{package_name}..."
    download(from: package['url'], to: archive_file_name)
    puts "Done."

    script_name = package['script'] || "#{package['name']}-#{package['version']}.sh"
    FileUtils.cp(File.join(scripts_folder, script_name), build_folder)

    puts "Running script #{script_name}"
    system({ "install_target" => target_folder }, script_name)
    puts "Done."
  end
end
