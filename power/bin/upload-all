#!/usr/bin/env ruby
require 'yaml'
require 'aws-sdk'

def usage
  puts "usage:"
  puts "  upload-all <manifest-file> <config-file>"
  puts
  puts "  upload dependencies to S3 and print package manifest"
  exit(1)
end

manifest_file = ARGV.first
config_file = ARGV.last
if manifest_file.nil? || !File.exist?(manifest_file) || config_file.nil? || !File.exist?(config_file)
  usage && exit(2)
end

packages = YAML.load_file(manifest_file)
config = YAML.load_file(config_file)

root_folder = File.expand_path(File.join(File.dirname(__FILE__), '..'))
binaries_folder = File.join(root_folder, 'binaries')

manifest = packages.map do |package|
  package_name = "#{package['name']}-#{package['version']}"
  archive_file_name = "#{package_name}.tar.gz"
  credentials = Aws::Credentials.new(config['access_key_id'], config['secret_access_key'])
  s3 = Aws::S3::Resource.new(credentials: credentials, region: config['region'])
  obj = s3.bucket(config['bucket']).object(archive_file_name)
  obj.upload_file(File.join(binaries_folder, archive_file_name))

  {
    'name'      => package['name'],
    'version'   => package['version'],
    'uri'       => obj.public_url, 
    'md5'       => Digest::MD5.file(File.join(binaries_folder, archive_file_name)).hexdigest,
    'cf_stacks' => [
      package['stack']
    ]
  }
end

puts "Everything is uploaded."

puts manifest.to_yaml
